# Global settings for the Argo CD chart
global:
  # Ingress is disabled because we use a custom HTTPRoute for external access
  ingress:
    enabled: false
# Argo CD server settings
server:
  # Extra configuration for the argocd-cm ConfigMap
  config:
    # URL for the Argo CD UI. Important for SSO redirects and notifications.
    url: https://argocd.vanillax.me
    # Application reconciliation timeout
    timeout.reconciliation: 180s
  # Resource requests and limits for the Argo CD server
  resources:
    requests:
      cpu: 150m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
# Config Management Plugin for Kustomize + Helm
configs:
  cmp:
    create: true
    plugins:
      kustomize-build-with-helm:
        generate:
          command: ["sh", "-c"]
          args: ["kustomize build --enable-helm"]
# Enable and configure the ApplicationSet controller
applicationSet:
  enabled: true
  # Resource requests and limits for the ApplicationSet controller
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m
# High Availability (HA) configuration for production environments
ha:
  enabled: true
  # Resource requests and limits for the HA redis
  redis:
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi
# Resource requests and limits for core Argo CD components
controller:
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
repoServer:
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
# Disable Dex as we are not using it for authentication in this setup
dex:
  enabled: false
# Add CMP sidecar to repo-server for Kustomize + Helm
repoServer:
  extraContainers:
    - name: kustomize-build-with-helm
      command:
        - argocd-cmp-server
      image: '{{ default .Values.global.image.repository .Values.repoServer.image.repository }}:{{ default (include "argo-cd.defaultTag" .) .Values.repoServer.image.tag }}'
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        seccompProfile:
          type: RuntimeDefault
        capabilities:
          drop: ["ALL"]
      volumeMounts:
        - name: plugins
          mountPath: /home/argocd/cmp-server/plugins
        - name: cmp-kustomize-build-with-helm
          mountPath: /home/argocd/cmp-server/config/plugin.yaml
          subPath: kustomize-build-with-helm.yaml
        - mountPath: /tmp
          name: cmp-tmp
  volumes:
    - name: cmp-kustomize-build-with-helm
      configMap:
        name: argocd-cmp-cm
    - name: cmp-tmp
      emptyDir: {}

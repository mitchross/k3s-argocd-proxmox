apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: node-problem-detector-alerts
  namespace: prometheus-stack
  labels:
    app.kubernetes.io/name: node-problem-detector
    release: kube-prometheus-stack
    prometheus: kube-prometheus-stack-prometheus
    role: alert-rules
spec:
  groups:
    - name: node-problem-detector.rules
      interval: 30s
      rules:
        # Node Problem Detector Health
        - alert: NodeProblemDetectorDown
          expr: up{job="node-problem-detector"} == 0
          for: 2m
          labels:
            severity: critical
            component: node-problem-detector
          annotations:
            summary: "Node Problem Detector is down on {{ $labels.instance }}"
            description: "Node Problem Detector has been down for more than 2 minutes on node {{ $labels.instance }}. Automatic cleanup tasks may not be running."
        # Node Problem Detector High Resource Usage
        - alert: NodeProblemDetectorHighCPU
          expr: rate(container_cpu_usage_seconds_total{container="node-problem-detector"}[5m]) > 0.1
          for: 5m
          labels:
            severity: warning
            component: node-problem-detector
          annotations:
            summary: "Node Problem Detector high CPU usage on {{ $labels.instance }}"
            description: "Node Problem Detector is using more than 100m CPU on node {{ $labels.instance }}."
        - alert: NodeProblemDetectorHighMemory
          expr: container_memory_working_set_bytes{container="node-problem-detector"} > 150000000
          for: 5m
          labels:
            severity: warning
            component: node-problem-detector
          annotations:
            summary: "Node Problem Detector high memory usage on {{ $labels.instance }}"
            description: "Node Problem Detector is using more than 150MB memory on node {{ $labels.instance }}."
        # Cleanup Activity Monitoring
        - alert: NodeProblemDetectorCleanupFailure
          expr: increase(node_problem_detector_cleanup_failures_total[10m]) > 0
          for: 2m
          labels:
            severity: warning
            component: node-problem-detector
          annotations:
            summary: "Node Problem Detector cleanup failures detected"
            description: "Node Problem Detector has encountered cleanup failures in the last 10 minutes."
        # Node Problem Detection
        - alert: NodeProblemDetected
          expr: node_problem_detector_problems_total > 0
          for: 1m
          labels:
            severity: info
            component: node-problem-detector
          annotations:
            summary: "Node problems detected by Node Problem Detector"
            description: "Node Problem Detector has detected problems on node {{ $labels.instance }}."
        # Evicted Pod Cleanup
        - alert: EvictedPodCleanupActive
          expr: increase(node_problem_detector_evicted_pods_cleaned_total[10m]) > 0
          for: 1m
          labels:
            severity: info
            component: node-problem-detector
          annotations:
            summary: "Evicted pod cleanup activity detected"
            description: "Node Problem Detector has cleaned up evicted pods in the last 10 minutes."
        # Failed Pod Cleanup
        - alert: FailedPodCleanupActive
          expr: increase(node_problem_detector_failed_pods_cleaned_total[10m]) > 0
          for: 1m
          labels:
            severity: info
            component: node-problem-detector
          annotations:
            summary: "Failed pod cleanup activity detected"
            description: "Node Problem Detector has cleaned up failed pods in the last 10 minutes."
        # Orphaned PVC Cleanup
        - alert: OrphanedPVCCleanupActive
          expr: increase(node_problem_detector_orphaned_pvcs_cleaned_total[10m]) > 0
          for: 1m
          labels:
            severity: info
            component: node-problem-detector
          annotations:
            summary: "Orphaned PVC cleanup activity detected"
            description: "Node Problem Detector has cleaned up orphaned PVCs in the last 10 minutes."
        # Completed Job Cleanup
        - alert: CompletedJobCleanupActive
          expr: increase(node_problem_detector_completed_jobs_cleaned_total[10m]) > 0
          for: 1m
          labels:
            severity: info
            component: node-problem-detector
          annotations:
            summary: "Completed job cleanup activity detected"
            description: "Node Problem Detector has cleaned up completed jobs in the last 10 minutes."

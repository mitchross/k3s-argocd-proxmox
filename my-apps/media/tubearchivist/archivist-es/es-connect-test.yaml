apiVersion: batch/v1
kind: Job
metadata:
  name: es-connect-test
  namespace: tubearchivist
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: false
        runAsUser: 0
      containers:
      - name: es-test
        image: bbilly1/tubearchivist:latest
        command: [ "python", "-c" ]
        args:
        - |
          import requests
          import os

          es_url = "http://archivist-es:9200"
          password = "verysecret"
          user = "elastic"

          try:
              print("Attempting to connect to Elasticsearch using Python requests from within the tubearchivist image...")
              response = requests.get(f"{es_url}/_cluster/health", auth=(user, password), timeout=5)
              response.raise_for_status()
              print("\nSUCCESS: Successfully connected to Elasticsearch.")
              print(response.text)
          except requests.exceptions.RequestException as e:
              print(f"\nFAILURE: Could not connect to Elasticsearch.")
              print(e)
